---
title: Android推送优化
date: 2017-08-17 15:53:04
tags: [Android]
---
在操蛋的国内 Android 环境下,最大程度优化 Android 推送<!--more-->

# 到底优化什么
优化Android 推送到底是优化什么?答:提高 **通用到达率**
下图是完整推送过程
![](https://ws4.sinaimg.cn/large/006tNc79gy1fqjamtyv4fj30j60ct0w2.jpg)


- 在线送达率: 表示的是，针对长连在线的设备进行消息下发，成功送达到设备的比例(注意，定义提及的只是送达到设备，而非送达到App这个层面)。 在线送达率 = 送达设备数/下发数 。绝大部分推送服务提供商所宣传的高送达率其实说的就是“在线送达率”。“在线送达率”是一个技术层面的指标，开发者不需要关注这个指标。
- 通用送达率: 表示的是，针对该次接受的设备集合，成功送达到App的比例(注意，定义提及的是送到到App，而非设备)。 通用送达率 = 送达App数 / 接收数。这个指标是开发者伙伴比较关注的。


# 国内推送环境

各推送平台大体可以分为三大类：

  大手机厂商的推送：小米推送、华为推送。

  专业的第三方推送：友盟推送、个推、极光推送

  BAT大厂的平台推送：阿里云移动推送、腾讯信鸽推送、百度云推送。

# 优化思路
## 1. 统计通用到达率
第一步先统计通用到达率是为了方便日后优化对比.一般来讲，“通用送达率”和App自身的活跃度呈正相关的。在App集成了推送SDK刚上线的时候，在推送后台看到的通用送达率会很高，之后会发现通用送达率就会随着时间的增长而逐步降低，直至最后稳定在一个数值上。这就说明了通用送达率和App的活跃度有很大的关系。不活跃的App，有可能是因为卸载导致，有可能是因为App没有启动过，导致和服务器的长连接建立不起来，从而导致服务器端无法下发消息(注: 消息下发的前提是设备联网且和服务器的长连通道建立)。下面是一个线上真实App的某次发送任务，细分到App的活跃区间，来看看App的活跃度对消息送达率的影响:
![](https://ws4.sinaimg.cn/large/006tNc79gy1fqjamv40q0j30ga07kta2.jpg).
这里有个问题需要考虑,通用到达率不仅仅这次推送能否到达设备有关,用户的活跃度也至关重要(这个是这次优化做不到的).单纯的对比这个参数,对推送是否真正在技术上实现了优化是不准确的.所以还需要仔细考虑一下如何设计实验.
## 2. 现有推送系统尽可能提高送达率.
这些需要用户手动操作第三方 ROM 的管理软件
- EMUI OS（华为）

**自启动管理：需要把应用加到【自启动管理】列表，否则杀进程或重新开机后进程不会开启，只能手动开启应用**
![](https://ws4.sinaimg.cn/large/006tNc79gy1fqjamvru5mj30rs0ghdia.jpg)
**后台应用保护：需要手动把应用加到此列表，否则设备进入睡眠后会自动杀掉应用进程，只有手动开启应用才能恢复运行**
![](https://ws4.sinaimg.cn/large/006tNc79gy1fqjamw981fj30ya0f941a.jpg)
**通知管理：应用状态有三种：提示、允许、禁止。禁止应用则通知栏不会有任何提醒**

- Flyme OS（魅族）

**自启动管理：需要把应用加到【自启动管理】列表，否则杀进程或重新开机后进程无法开启**
![](https://ws1.sinaimg.cn/large/006tNc79gy1fqjamwoofoj30z00fkq5p.jpg)

**通知栏推送：关闭应用通知则收到消息不会有任何展示**

**省电管理： 安全中心里设置省电模式，在【待机耗电管理】中允许应用待机时，保持允许，否则手机休眠或者应用闲置一段时间，无法正常接收消息。**
![](https://ws3.sinaimg.cn/large/006tNc79gy1fqjamx6enaj30z00fk77a.jpg)

- Funtouch OS（VIVO）

**自启动管理：需要将应用加入“i管家”中的【自启动管理】列表，否则重启手机后进程不会自启。但强制手动杀进程，即使加了这个列表中，后续进程也无法自启动。**

- Color OS（OPPO）

**冻结应用管理：需要将应用加入纯净后台，否则锁屏状态下无法及时收到消息**

**自启动管理：将应用加入【自启动管理】列表的同时，还需要到设置-应用程序-正在运行里锁定应用进程，否则杀进程或者开机后进程不会开启，只能手动开启应用**


- MIUI OS (小米)

**自启动管理：需要把应用加到【自启动管理】列表，否则杀进程或重新开机后进程无法开启**
![](https://ws1.sinaimg.cn/large/006tNc79gy1fqjamy3adpj30sg0gv0uu.jpg)

**通知提示设置：应用默认都是显示通知栏通知，如果关闭，则收到通知也不会提示**

**网络助手：可以手动禁止已安装的第三方程序访问2G/3G和WIFI的网络和设置以后新安装程序是否允许访问2G/3G和WIFI的网络**

**MIUI 7 神隐模式： 允许用户设置后台联网应用，开启后应用即可在后台保持联网，否则应用进入后台时，应用无法正常接收消息。【设置】->【电量和性能】->【神隐模式】**

![](https://ws2.sinaimg.cn/large/006tNc79gy1fqjamz0o69j30z00fk0up.jpg)

## 3. 优化推送的初始化和推送token的同步
我们使用第三方推送平台，最关键的地方在于前两个步骤：

- 在恰当的时机把推送SDK初始化起来。
- 初始化之后App会异步地收到一个推送token，那么接下来需要把这个推送token同步到App服务器。

这里的推送token，在不同的推送平台上的叫法不太一样，比如在小米推送中被称为reg id，在华为推送中被称为token，在个推中被称为cid，在友盟推送被称为Device Token。总之，它是推送平台对设备的唯一标识。我们这里统称它为“推送token”是为了方便讨论。

App的客户端拿到它之后，必须要同步到自己的服务器，并与自己的用户ID建立起对应关系。这样当我们想推送消息给我们的某个用户的时候，我们才能查到对应的推送token。

前面说的初始化和推送token同步这两个步骤，看起来很简单，只是调用SDK的现成接口，再把它发送给服务器而已。但是，好的代码不仅能在正常情况下工作，还应该充分考虑失败情况。有什么样的失败情况需要我们考虑呢？我们以小米推送为例来分析一下：

小米推送要求在Application对象的onCreate中执行初始化操作。我们可以猜测一下，在这个初始化操作中小米推送的SDK可能需要在本地为我们修改配置，还可能需要联系小米推送的服务器来申请reg id（即推送token）。这个初始化过程是可能失败的，本地操作可能会受到系统的限制，网络更是可能出错。试想，如果初始化出错了，我们还会收到推送token吗？
假设我们成功收到了推送token（通常在一个BroadcastReceiver中），接下来把推送token发送到我们自己的服务器，这个工作需要我们自己来完成了。我们都知道在移动环境下网络很可能是弱网环境，这次同步如果失败了，那么下次要等到什么机会才能再次进行同步呢？
上述第一种初始化错误，理应由推送SDK来处理。如果失败，它应该会有重试机制，直到成功获取了推送token，它再重新调用App把推送token传过来。比如，小米推送平台也是这么宣称的，初始化可能出现的错误，App开发者不用考虑。如果你充分信任推送平台，那么这个错误其实是可以不用去考虑的；否则，你可以在App里增加某些机会来检测初始化是否已经成功（可以通过检测是否已经拿到推送token来确定），然后在恰当的时机重新调用初始化代码。当然，在做这个事情之前，你最好与推送平台沟通清楚，确保重复调用初始化代码不会产生什么副作用。

上述第二种错误，就必须靠App开发者自己处理了。这里我们实际上需要在App客户端和服务器之间抽象出一条强的通信通道，我们把同步推送token的请求放进去，这条通信通道能够在失败发生的时候自动重试。

- 可以加入推送是否打开检查.如果用户关闭了推送开关,可以提醒其引导用户打开.



## 4. 接入混合推送
这里如果有第三方解决方案可以试一下,如果没有自己也可以做,但是实现成本可能会比较高,需要后台配合改造.
目前好哒商户通团队接入的个推企业版,实际上就是个推自己在他们服务端做了混合推送.
## 5. 自己搭建端内推送
自己的推送系统更快、更有保障：
- 更快，是因为你交给第三方推送平台的推送消息要跟很多其它家App的消息一起排队。如果某家App突然在短时间内发送大量推送消息给推送平台（推广活动，或者程序bug），那么这个推送平台上的其它App就有可能受到牵连，推送延迟变得很大。这样的情况是很可能会发生的。
- 更有保障。大厂通常有专门的队伍维护推送相关的服务，有问题可以快速推进优化。

-- #### 学习链接

[什么叫做到达率](http://bbs.umeng.com/thread-8933-1-1.html)

[关于推送你应该知道的一切](http://blog.csdn.net/eclipsexys/article/details/52575602#t7)

[混合推送你应该知道的一切](https://juejin.im/post/57a19c012e958a0066715d0c)

[Android通知栏介绍与适配总结](http://iluhcm.com/2017/03/12/experience-of-adapting-to-android-notifications/)

[App判断通知屏蔽并请求跳转设置](http://feihu.blog/?p=524)
